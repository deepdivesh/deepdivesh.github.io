<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="//gmpg.org/xfn/11" rel="profile">

  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css?1549235075319875000">
  <link rel="stylesheet" href="/public/css/lanyon.css?1549235075319875000">
  <link rel="stylesheet" href="/public/css/monokai.css?1549235075319875000">
  <link href="https://fonts.googleapis.com/css?family=Lora|Open+Sans:300,700" rel="stylesheet">

  <link rel="icon" sizes="16x16 32x32 64x64" href="/public/favicon.ico">
<link rel="icon" type="image/png" sizes="196x196" href="/public/favicon-196.png">
<link rel="icon" type="image/png" sizes="160x160" href="/public/favicon-160.png">
<link rel="icon" type="image/png" sizes="128x128" href="/public/favicon-128.png">
<link rel="icon" type="image/png" sizes="96x96" href="/public/favicon-96.png">
<link rel="icon" type="image/png" sizes="64x64" href="/public/favicon-64.png">
<link rel="icon" type="image/png" sizes="32x32" href="/public/favicon-32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/public/favicon-16.png">
<link rel="apple-touch-icon" href="/public/favicon-57.png">
<link rel="apple-touch-icon" sizes="180x180" href="/public/favicon-180.png">
<link rel="apple-touch-icon" sizes="152x152" href="/public/favicon-152.png">
<link rel="apple-touch-icon" sizes="144x144" href="/public/favicon-144.png">
<link rel="apple-touch-icon" sizes="120x120" href="/public/favicon-120.png">
<link rel="apple-touch-icon" sizes="114x114" href="/public/favicon-114.png">
<link rel="apple-touch-icon" sizes="76x76" href="/public/favicon-76.png">
<link rel="apple-touch-icon" sizes="72x72" href="/public/favicon-72.png">
<link rel="apple-touch-icon" sizes="60x60" href="/public/favicon-60.png">
<meta name="msapplication-TileColor" content="#FFFFFF">
<meta name="msapplication-TileImage" content="/public/favicon-144.png">
<meta name="msapplication-config" content="/public/browserconfig.xml">


  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">

  <!-- Begin Jekyll SEO tag v2.5.0 -->
<meta name="generator" content="Jekyll v3.7.4" />
<meta property="og:title" content="Refactor a large case statement" />
<meta name="author" content="Hrvoje Šimić" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I&#39;m currently building a gem for converting curl commands to something else, and one early problem I needed to deal with was parsing the curl command arguments." />
<meta property="og:description" content="I&#39;m currently building a gem for converting curl commands to something else, and one early problem I needed to deal with was parsing the curl command arguments." />
<link rel="canonical" href="http://shime.sh/til/refactor-a-large-case-statement" />
<meta property="og:url" content="http://shime.sh/til/refactor-a-large-case-statement" />
<meta property="og:site_name" content="Hrvoje Šimić" />
<meta property="og:image" content="http://shime.sh/public/social.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-02-03T00:00:00+01:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:site" content="@shime_sh" />
<meta name="twitter:creator" content="@shime_sh" />
<script type="application/ld+json">
{"image":"http://shime.sh/public/social.jpg","url":"http://shime.sh/til/refactor-a-large-case-statement","headline":"Refactor a large case statement","dateModified":"2019-02-03T00:00:00+01:00","datePublished":"2019-02-03T00:00:00+01:00","author":{"@type":"Person","name":"Hrvoje Šimić"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://shime.sh/til/refactor-a-large-case-statement"},"description":"I&#39;m currently building a gem for converting curl commands to something else, and one early problem I needed to deal with was parsing the curl command arguments.","@type":"BlogPosting","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <title> Refactor a large case statement &middot; Hrvoje Šimić </title>
  <meta name="title" content="Refactor a large case statement &middot; Hrvoje Šimić">
</head>


  <body>
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <ul class="masthead-navigation">
            
              <li>
                
                  <a href='/articles/'>Articles</a>
                
              </li>
            
              <li>
                
                  <a href='/til/'>TIL</a>
                
              </li>
            
              <li>
                
                  <a href='/photography/'>Photography</a>
                
              </li>
            
              <li>
                
                  <a href='/reading/'>Reading list</a>
                
              </li>
            
          </ul>
        </div>
        <div class="clear"></div>
      </div>

      <div class="container content">
        <div class="post">
  <div class="post-meta">
    <h1 class="post-title">Refactor a large case statement</h1>
    <div class="published">
      February 3, 2019 in
      ruby
    </div>
  </div>
  <p>I&#39;m currently building a gem for converting
curl commands to something else, and one early
problem I needed to deal with was parsing the 
curl command arguments.</p>

<p>The basic idea for a gem is to convert curl command to
a sweet looking hash that we can use to do
magical things. So when given:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">curl https://isrubydead.com/
</code></pre></div>
<p>Our program converts it to:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="p">{</span>
  <span class="s2">"body"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
  <span class="s2">"method"</span><span class="p">:</span> <span class="s2">"GET"</span><span class="p">,</span>
  <span class="s2">"headers"</span><span class="p">:</span> <span class="p">{},</span>
  <span class="s2">"url"</span><span class="p">:</span> <span class="s2">"https://isrubydead.com/"</span>
<span class="p">}</span>
</code></pre></div>
<p>We&#39;ll call this hash a <code>Request</code>, so let&#39;s define it:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">Request</span> <span class="o">=</span> <span class="no">Struct</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:body</span><span class="p">,</span> <span class="ss">:method</span><span class="p">,</span> <span class="ss">:headers</span><span class="p">,</span> <span class="ss">:url</span><span class="p">)</span> <span class="k">do</span>
  <span class="k">def</span> <span class="nf">initialize</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">method</span> <span class="o">=</span> <span class="s1">'GET'</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">headers</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">url</span> <span class="o">=</span> <span class="s1">''</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">body</span> <span class="o">=</span> <span class="s1">''</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>Now that we have a place to store the result of parsing 
the curl command, it&#39;s time to write an actual parser.</p>

<p>Being a very serious and very senior developer,
I&#39;ve ended up with this very appealing class:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Parser</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="vi">@request</span> <span class="o">=</span> <span class="n">request</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">words</span><span class="p">)</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">words</span> <span class="o">=</span> <span class="n">words</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">word</span> <span class="o">=</span> <span class="n">words</span><span class="p">.</span><span class="nf">shift</span><span class="p">)</span>
      <span class="n">parse_word</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="nb">attr_accessor</span> <span class="ss">:words</span>
  <span class="nb">attr_reader</span> <span class="ss">:request</span>

  <span class="k">def</span> <span class="nf">parse_word</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
    <span class="k">case</span> <span class="n">word</span>
    <span class="k">when</span> <span class="no">URI</span><span class="o">::</span><span class="no">DEFAULT_PARSER</span><span class="p">.</span><span class="nf">make_regexp</span>
      <span class="n">request</span><span class="p">.</span><span class="nf">url</span> <span class="o">=</span> <span class="n">word</span>
    <span class="k">when</span> <span class="sr">/\A(-H|--header)\Z/</span>
      <span class="n">parse_header</span>
    <span class="k">when</span> <span class="sr">/\A--compressed\Z/</span>
      <span class="n">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Accept-Encoding'</span><span class="p">]</span> <span class="o">||=</span> <span class="s1">'deflate, gzip'</span>
    <span class="k">when</span> <span class="sr">/\A-X|\A--request\Z/</span>
      <span class="n">request</span><span class="p">.</span><span class="nf">method</span> <span class="o">=</span> <span class="n">extract_method</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
    <span class="k">when</span> <span class="sr">/\A(-u|--user)\Z/</span>
      <span class="n">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Authorization'</span><span class="p">]</span> <span class="o">||=</span>
        <span class="s2">"Basic </span><span class="si">#{</span><span class="no">Base64</span><span class="p">.</span><span class="nf">strict_encode64</span><span class="p">(</span><span class="n">words</span><span class="p">.</span><span class="nf">shift</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">when</span> <span class="sr">/\A(-b|--cookie)\Z/</span>
      <span class="n">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Set-Cookie'</span><span class="p">]</span> <span class="o">||=</span> <span class="n">words</span><span class="p">.</span><span class="nf">shift</span>
    <span class="k">when</span> <span class="sr">/\A(-A|--user-agent)\Z/</span>
      <span class="n">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'User-Agent'</span><span class="p">]</span> <span class="o">||=</span> <span class="n">words</span><span class="p">.</span><span class="nf">shift</span>
    <span class="k">when</span> <span class="sr">/\A(-I|--head)\Z/</span>
      <span class="n">request</span><span class="p">.</span><span class="nf">method</span> <span class="o">=</span> <span class="s1">'HEAD'</span>
    <span class="k">when</span> <span class="sr">/\A(-d|--data|--data-ascii)\Z/</span>
      <span class="n">parse_data</span>
    <span class="k">when</span> <span class="sr">/\A--data-binary\Z/</span>
      <span class="n">parse_data</span><span class="p">(</span><span class="ss">strip_newlines: </span><span class="kp">false</span><span class="p">)</span>
    <span class="k">when</span> <span class="sr">/\A--data-raw\Z/</span>
      <span class="n">parse_data</span><span class="p">(</span><span class="ss">raw: </span><span class="kp">true</span><span class="p">)</span>
    <span class="k">when</span> <span class="sr">/\A--data-urlencode\Z/</span>
      <span class="n">parse_data</span><span class="p">(</span><span class="ss">url_encode: </span><span class="kp">true</span><span class="p">)</span>
    <span class="k">when</span> <span class="sr">/\./</span>
      <span class="n">request</span><span class="p">.</span><span class="nf">url</span> <span class="o">=</span> <span class="s2">"http://</span><span class="si">#{</span><span class="n">word</span><span class="si">}</span><span class="s2">"</span> <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="nf">url</span> <span class="o">==</span> <span class="s1">''</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>I know, a thing a beauty.</p>

<p>What&#39;s also very nice is that this class
also have to know everything about parsing curl arguments;
from header and method arguments to various data arguments.</p>

<p>Super nice! Just look at these beautiful methods, that
all belong to this class:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Parser</span>
  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">parse_data</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>
    <span class="n">request</span><span class="p">.</span><span class="nf">method</span> <span class="o">=</span> <span class="s1">'POST'</span> <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="nf">method</span> <span class="o">==</span> <span class="s1">'GET'</span> <span class="o">||</span>
                               <span class="n">request</span><span class="p">.</span><span class="nf">method</span> <span class="o">==</span> <span class="s1">'HEAD'</span>
    <span class="n">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Content-Type'</span><span class="p">]</span> <span class="o">||=</span>
      <span class="s1">'application/x-www-form-urlencoded'</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">extract_data</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="n">request</span><span class="p">.</span><span class="nf">body</span> <span class="o">=</span> <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="nf">body</span><span class="p">.</span><span class="nf">empty?</span>
                     <span class="n">data</span>
                   <span class="k">else</span>
                     <span class="s2">"</span><span class="si">#{</span><span class="n">request</span><span class="p">.</span><span class="nf">body</span><span class="si">}</span><span class="s2">&amp;</span><span class="si">#{</span><span class="n">data</span><span class="si">}</span><span class="s2">"</span>
                   <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">parse_header</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">extract_header</span><span class="p">(</span><span class="n">words</span><span class="p">.</span><span class="nf">shift</span><span class="p">)</span>

    <span class="k">return</span> <span class="k">unless</span> <span class="n">header</span>

    <span class="n">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="n">header</span><span class="p">.</span><span class="nf">keys</span><span class="p">.</span><span class="nf">first</span><span class="p">]</span> <span class="o">=</span>
      <span class="n">header</span><span class="p">.</span><span class="nf">values</span><span class="p">.</span><span class="nf">first</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">extract_data</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">words</span><span class="p">.</span><span class="nf">shift</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">read_file</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="k">if</span> <span class="n">data</span> <span class="o">=~</span> <span class="sr">/\A@/</span> <span class="o">||</span> <span class="n">args</span><span class="p">[</span><span class="ss">:raw</span><span class="p">]</span>
    <span class="n">data</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">read_file</span><span class="p">(</span><span class="n">word</span><span class="p">,</span>
                <span class="ss">strip_newlines: </span><span class="kp">true</span><span class="p">,</span>
                <span class="ss">raw: </span><span class="kp">false</span><span class="p">,</span>
                <span class="ss">url_encode: </span><span class="kp">false</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">raw</span> <span class="p">?</span> <span class="n">word</span> <span class="p">:</span> <span class="n">word</span><span class="p">[</span><span class="mi">1</span><span class="o">..-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">content</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">content</span><span class="p">.</span><span class="nf">gsub!</span><span class="p">(</span><span class="sr">/\n|\r/</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span> <span class="k">if</span> <span class="n">strip_newlines</span>
    <span class="n">content</span> <span class="o">=</span> <span class="no">CGI</span><span class="p">.</span><span class="nf">escape</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="k">if</span> <span class="n">url_encode</span>
    <span class="n">content</span>
  <span class="k">rescue</span> <span class="no">Errno</span><span class="o">::</span><span class="no">ENOENT</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">expand_path</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="o">..-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">raise</span> <span class="no">FileNotFoundError</span><span class="p">,</span>
      <span class="s2">"Cannot read file: </span><span class="si">#{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">. Does it exist?"</span>
  <span class="k">end</span>

  <span class="c1"># Needed for extracting -XPUT and similar formats.</span>
  <span class="k">def</span> <span class="nf">extract_method</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">words</span><span class="p">.</span><span class="nf">shift</span> <span class="k">unless</span> <span class="n">word</span> <span class="o">=~</span> <span class="sr">/^-X/</span>

    <span class="k">if</span> <span class="o">!</span><span class="p">(</span><span class="nb">method</span> <span class="o">=</span> <span class="n">word</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sr">/^-X(.*)/</span><span class="p">)[</span><span class="mi">1</span><span class="p">]).</span><span class="nf">empty?</span>
      <span class="nb">method</span>
    <span class="k">else</span>
      <span class="n">words</span><span class="p">.</span><span class="nf">shift</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">extract_header</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
    <span class="p">[</span><span class="n">header</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sr">/: (.+)/</span><span class="p">)].</span><span class="nf">to_h</span>
  <span class="k">rescue</span> <span class="no">StandardError</span>
    <span class="kp">nil</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>Marvelous! This class knows absolutely everything
about curl and all the arguments and options.
We could ask it the curl&#39;s shoe size, 
and it would give us the answer.</p>

<p>Now that we have thought this class so much, and it
has achieved the master&#39;s degree worth of education
in the University of curl, I&#39;m a little worried it&#39;s going to take over the world.</p>

<p>Sure, it only knows about curl for now, but what happens
when someone decides it should know about, I don&#39;t know,
some scary AI thing. It looks innocent right now,
but then you turn around and it <a href="https://www.youtube.com/watch?v=aFuA50H9uek">gets interested in doors</a>. </p>

<p>I don&#39;t trust it one bit, so let&#39;s steal some knowledge
from this class and let&#39;s spread it to other classes.</p>

<p><em>I&#39;ll now start explaining the refactoring step by step,
but you can take a look at <a href="#final">the final result</a> if you&#39;d like to
skip.</em></p>

<p>This class will from now on be ignorant of curl arguments, so the humongous case statement becomes:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Parser</span>
  <span class="k">def</span> <span class="nf">parse_word</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
    <span class="no">Word</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">words</span><span class="p">,</span> <span class="n">word</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>Since every scenario we have to cover in the case statement consists
of the regex check, the idea is to abstract those into 
class.</p>

<p>Let&#39;s introduce the <code>Word::Base</code> class:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">Word</span>
  <span class="k">class</span> <span class="nc">Base</span>
    <span class="c1"># Used to check if the word given matches the subclass' regex.</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">===</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
      <span class="n">word</span> <span class="o">=~</span> <span class="n">regex</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="k">raise</span> <span class="no">NotImplementedError</span><span class="p">,</span> <span class="s2">"</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2"> doesn't have .regex defined"</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
      <span class="k">raise</span> <span class="no">NotImplementedError</span><span class="p">,</span> <span class="s2">"</span><span class="si">#{</span><span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">name</span><span class="si">}</span><span class="s2"> doesn't have #parse defined"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>The plan is to have one base class, that will be inherited for every
scenario we&#39;d like to cover. Here&#39;s the first example of one such class:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">Word</span>
  <span class="k">class</span> <span class="nc">Header</span> <span class="o">&lt;</span> <span class="no">Base</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\A(-H|--header)\Z/</span><span class="p">.</span><span class="nf">freeze</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
      <span class="n">header</span> <span class="o">=</span> <span class="n">extract_header</span><span class="p">(</span><span class="n">words</span><span class="p">.</span><span class="nf">shift</span><span class="p">)</span>

      <span class="k">return</span> <span class="k">unless</span> <span class="n">header</span>

      <span class="n">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="n">header</span><span class="p">.</span><span class="nf">keys</span><span class="p">.</span><span class="nf">first</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">.</span><span class="nf">values</span><span class="p">.</span><span class="nf">first</span>
    <span class="k">end</span>

    <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">extract_header</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
      <span class="p">[</span><span class="n">header</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sr">/: (.+)/</span><span class="p">)].</span><span class="nf">to_h</span>
    <span class="k">rescue</span> <span class="no">StandardError</span>
      <span class="kp">nil</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>This class stores information about everything that&#39;s needed to
parse a header argument. It detects the argument (when the curl command includes
<code>-H</code> or <code>--header</code> in arguments) and then changes the request hash,
which we return in the end.</p>

<p>Since this class has to know about <code>words</code> and <code>request</code>
too, we&#39;ll add that to the base class. We expect other descendants
to need that too:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">Word</span>
  <span class="k">class</span> <span class="nc">Base</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">words</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
      <span class="vi">@words</span> <span class="o">=</span> <span class="n">words</span>
      <span class="vi">@request</span> <span class="o">=</span> <span class="n">request</span>
    <span class="k">end</span>

    <span class="kp">private</span>

    <span class="nb">attr_reader</span> <span class="ss">:words</span>
    <span class="nb">attr_reader</span> <span class="ss">:request</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>The next problem we have is that there&#39;s no connection between
the original <code>parse_word</code> method and this new class we have created,
so let&#39;s write a method that connects those two:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">Word</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">words</span><span class="p">,</span> <span class="n">word</span><span class="p">)</span>
    <span class="n">subclass</span> <span class="o">=</span> <span class="no">Word</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">subclasses</span>
                         <span class="p">.</span><span class="nf">detect</span> <span class="p">{</span> <span class="o">|</span><span class="n">klass</span><span class="o">|</span> <span class="n">klass</span> <span class="o">===</span> <span class="n">word</span> <span class="p">}</span>
    <span class="n">subclass</span><span class="o">&amp;</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">words</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span><span class="o">&amp;</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">Base</span>
    <span class="c1"># List of subclasses, first-inherited class first.</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">subclasses</span>
      <span class="no">ObjectSpace</span><span class="p">.</span><span class="nf">each_object</span><span class="p">(</span><span class="no">Base</span><span class="p">.</span><span class="nf">singleton_class</span><span class="p">)</span>
                 <span class="p">.</span><span class="nf">reject</span> <span class="p">{</span> <span class="o">|</span><span class="n">klass</span><span class="o">|</span> <span class="n">klass</span> <span class="o">==</span> <span class="no">Base</span> <span class="p">}.</span><span class="nf">reverse</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>With this method we can find a <code>Word::Base</code> subclass that matches the word
that was given and then parses that word. If we find the subclass,
we try to parse the word. So our current code works
for parsing <code>--header</code> or <code>-h</code> words from curl.</p>

<p>Our code now supports parsing headers, so let&#39;s proceed to add
classes for every argument we&#39;d like to support:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">Word</span>
  <span class="k">class</span> <span class="nc">Compressed</span> <span class="o">&lt;</span> <span class="no">Base</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\A--compressed\Z/</span><span class="p">.</span><span class="nf">freeze</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
      <span class="n">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Accept-Encoding'</span><span class="p">]</span> <span class="o">||=</span> <span class="s1">'deflate, gzip'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">Request</span> <span class="o">&lt;</span> <span class="no">Base</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\A-X|\A--request\Z/</span><span class="p">.</span><span class="nf">freeze</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
      <span class="n">request</span><span class="p">.</span><span class="nf">method</span> <span class="o">=</span> <span class="n">extract_method</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="kp">private</span>

    <span class="c1"># Needed for extracting -XPUT and similar formats.</span>
    <span class="k">def</span> <span class="nf">extract_method</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">words</span><span class="p">.</span><span class="nf">shift</span> <span class="k">unless</span> <span class="n">word</span> <span class="o">=~</span> <span class="sr">/^-X/</span>

      <span class="k">if</span> <span class="o">!</span><span class="p">(</span><span class="nb">method</span> <span class="o">=</span> <span class="n">word</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sr">/^-X(.*)/</span><span class="p">)[</span><span class="mi">1</span><span class="p">]).</span><span class="nf">empty?</span>
        <span class="nb">method</span>
      <span class="k">else</span>
        <span class="n">words</span><span class="p">.</span><span class="nf">shift</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">Authorization</span> <span class="o">&lt;</span> <span class="no">Base</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\A(-u|--user)\Z/</span><span class="p">.</span><span class="nf">freeze</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
      <span class="n">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Authorization'</span><span class="p">]</span> <span class="o">||=</span>
        <span class="s2">"Basic </span><span class="si">#{</span><span class="no">Base64</span><span class="p">.</span><span class="nf">strict_encode64</span><span class="p">(</span><span class="n">words</span><span class="p">.</span><span class="nf">shift</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">Cookie</span> <span class="o">&lt;</span> <span class="no">Base</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\A(-b|--cookie)\Z/</span><span class="p">.</span><span class="nf">freeze</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
      <span class="n">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Set-Cookie'</span><span class="p">]</span> <span class="o">||=</span> <span class="n">words</span><span class="p">.</span><span class="nf">shift</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">UserAgent</span> <span class="o">&lt;</span> <span class="no">Base</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\A(-A|--user-agent)\Z/</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
      <span class="n">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'User-Agent'</span><span class="p">]</span> <span class="o">||=</span> <span class="n">words</span><span class="p">.</span><span class="nf">shift</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">Head</span> <span class="o">&lt;</span> <span class="no">Base</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\A(-I|--head)\Z/</span><span class="p">.</span><span class="nf">freeze</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
      <span class="n">request</span><span class="p">.</span><span class="nf">method</span> <span class="o">=</span> <span class="s1">'HEAD'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">Data</span> <span class="o">&lt;</span> <span class="no">Base</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\A(-d|--data|--data-ascii)\Z/</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">options</span>
      <span class="p">{}</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
      <span class="n">request</span><span class="p">.</span><span class="nf">method</span> <span class="o">=</span> <span class="s1">'POST'</span> <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="nf">method</span> <span class="o">==</span> <span class="s1">'GET'</span> <span class="o">||</span>
                                 <span class="n">request</span><span class="p">.</span><span class="nf">method</span> <span class="o">==</span> <span class="s1">'HEAD'</span>
      <span class="n">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Content-Type'</span><span class="p">]</span> <span class="o">||=</span>
        <span class="s1">'application/x-www-form-urlencoded'</span>

      <span class="n">data</span> <span class="o">=</span> <span class="n">extract_data</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

      <span class="n">request</span><span class="p">.</span><span class="nf">body</span> <span class="o">=</span> <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="nf">body</span><span class="p">.</span><span class="nf">empty?</span>
                       <span class="n">data</span>
                     <span class="k">else</span>
                       <span class="s2">"</span><span class="si">#{</span><span class="n">request</span><span class="p">.</span><span class="nf">body</span><span class="si">}</span><span class="s2">&amp;</span><span class="si">#{</span><span class="n">data</span><span class="si">}</span><span class="s2">"</span>
                     <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">extract_data</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
      <span class="n">data</span> <span class="o">=</span> <span class="n">words</span><span class="p">.</span><span class="nf">shift</span>
      <span class="n">data</span> <span class="o">=</span> <span class="n">read_file</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="k">if</span> <span class="n">data</span> <span class="o">=~</span> <span class="sr">/\A@/</span> <span class="o">||</span>
                                      <span class="n">args</span><span class="p">[</span><span class="ss">:raw</span><span class="p">]</span>
      <span class="n">data</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">read_file</span><span class="p">(</span><span class="n">word</span><span class="p">,</span>
                  <span class="ss">strip_newlines: </span><span class="kp">true</span><span class="p">,</span>
                  <span class="ss">raw: </span><span class="kp">false</span><span class="p">,</span>
                  <span class="ss">url_encode: </span><span class="kp">false</span><span class="p">)</span>
      <span class="n">path</span> <span class="o">=</span> <span class="n">raw</span> <span class="p">?</span> <span class="n">word</span> <span class="p">:</span> <span class="n">word</span><span class="p">[</span><span class="mi">1</span><span class="o">..-</span><span class="mi">1</span><span class="p">]</span>
      <span class="n">content</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
      <span class="n">content</span><span class="p">.</span><span class="nf">gsub!</span><span class="p">(</span><span class="sr">/\n|\r/</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span> <span class="k">if</span> <span class="n">strip_newlines</span>
      <span class="n">content</span> <span class="o">=</span> <span class="no">CGI</span><span class="p">.</span><span class="nf">escape</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="k">if</span> <span class="n">url_encode</span>
      <span class="n">content</span>
    <span class="k">rescue</span> <span class="no">Errno</span><span class="o">::</span><span class="no">ENOENT</span>
      <span class="n">file_path</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">expand_path</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="o">..-</span><span class="mi">1</span><span class="p">])</span>
      <span class="k">raise</span> <span class="no">FileNotFoundError</span><span class="p">,</span>
            <span class="s2">"Cannot read file: </span><span class="si">#{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">. Does it exist?"</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">StripNewlinesData</span> <span class="o">&lt;</span> <span class="no">Data</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\A--data-binary\Z/</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">options</span>
      <span class="p">{</span> <span class="ss">strip_newlines: </span><span class="kp">false</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">RawData</span> <span class="o">&lt;</span> <span class="no">Data</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\A--data-raw\Z/</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">options</span>
      <span class="p">{</span> <span class="ss">raw: </span><span class="kp">true</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">URLEncodeData</span> <span class="o">&lt;</span> <span class="no">Data</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\A--data-urlencode\Z/</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">options</span>
      <span class="p">{</span> <span class="ss">url_encode: </span><span class="kp">true</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">URL</span> <span class="o">&lt;</span> <span class="no">Base</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">===</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
      <span class="n">word</span> <span class="o">=~</span> <span class="no">URI</span><span class="o">::</span><span class="no">DEFAULT_PARSER</span><span class="p">.</span><span class="nf">make_regexp</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
      <span class="n">request</span><span class="p">.</span><span class="nf">url</span> <span class="o">=</span> <span class="n">word</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">NonStrictURL</span> <span class="o">&lt;</span> <span class="no">Base</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\./</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
      <span class="n">request</span><span class="p">.</span><span class="nf">url</span> <span class="o">=</span> <span class="s2">"http://</span><span class="si">#{</span><span class="n">word</span><span class="si">}</span><span class="s2">"</span> <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="nf">url</span> <span class="o">==</span> <span class="s1">''</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>Here&#39;s the <a name="final">final</a> code we end up with:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">Word</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">words</span><span class="p">,</span> <span class="n">word</span><span class="p">)</span>
    <span class="n">subclass</span> <span class="o">=</span> <span class="no">Word</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">subclasses</span>
                         <span class="p">.</span><span class="nf">detect</span> <span class="p">{</span> <span class="o">|</span><span class="n">klass</span><span class="o">|</span> <span class="n">klass</span> <span class="o">===</span> <span class="n">word</span> <span class="p">}</span>
    <span class="n">subclass</span><span class="o">&amp;</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">words</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span><span class="o">&amp;</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">Base</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">words</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
      <span class="vi">@words</span> <span class="o">=</span> <span class="n">words</span>
      <span class="vi">@request</span> <span class="o">=</span> <span class="n">request</span>
    <span class="k">end</span>

    <span class="c1"># List of subclasses, first-inherited class appears first.</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">subclasses</span>
      <span class="no">ObjectSpace</span><span class="p">.</span><span class="nf">each_object</span><span class="p">(</span><span class="no">Base</span><span class="p">.</span><span class="nf">singleton_class</span><span class="p">)</span>
                 <span class="p">.</span><span class="nf">reject</span> <span class="p">{</span> <span class="o">|</span><span class="n">klass</span><span class="o">|</span> <span class="n">klass</span> <span class="o">==</span> <span class="no">Base</span> <span class="p">}.</span><span class="nf">reverse</span>
    <span class="k">end</span>

    <span class="c1"># Used to check if the word given matches the subclass' regex.</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">===</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
      <span class="n">word</span> <span class="o">=~</span> <span class="n">regex</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="k">raise</span> <span class="no">NotImplementedError</span><span class="p">,</span>
            <span class="s2">"</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2"> doesn't have .regex defined"</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
      <span class="k">raise</span> <span class="no">NotImplementedError</span><span class="p">,</span>
            <span class="s2">"</span><span class="si">#{</span><span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">name</span><span class="si">}</span><span class="s2"> doesn't have #parse defined"</span>
    <span class="k">end</span>

    <span class="kp">private</span>

    <span class="nb">attr_reader</span> <span class="ss">:words</span>
    <span class="nb">attr_reader</span> <span class="ss">:request</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">Header</span> <span class="o">&lt;</span> <span class="no">Base</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\A(-H|--header)\Z/</span><span class="p">.</span><span class="nf">freeze</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
      <span class="n">header</span> <span class="o">=</span> <span class="n">extract_header</span><span class="p">(</span><span class="n">words</span><span class="p">.</span><span class="nf">shift</span><span class="p">)</span>

      <span class="k">return</span> <span class="k">unless</span> <span class="n">header</span>

      <span class="n">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="n">header</span><span class="p">.</span><span class="nf">keys</span><span class="p">.</span><span class="nf">first</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">.</span><span class="nf">values</span><span class="p">.</span><span class="nf">first</span>
    <span class="k">end</span>

    <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">extract_header</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
      <span class="p">[</span><span class="n">header</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sr">/: (.+)/</span><span class="p">)].</span><span class="nf">to_h</span>
    <span class="k">rescue</span> <span class="no">StandardError</span>
      <span class="kp">nil</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">Compressed</span> <span class="o">&lt;</span> <span class="no">Base</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\A--compressed\Z/</span><span class="p">.</span><span class="nf">freeze</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
      <span class="n">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Accept-Encoding'</span><span class="p">]</span> <span class="o">||=</span> <span class="s1">'deflate, gzip'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">Request</span> <span class="o">&lt;</span> <span class="no">Base</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\A-X|\A--request\Z/</span><span class="p">.</span><span class="nf">freeze</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
      <span class="n">request</span><span class="p">.</span><span class="nf">method</span> <span class="o">=</span> <span class="n">extract_method</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="kp">private</span>

    <span class="c1"># Needed for extracting -XPUT and similar formats.</span>
    <span class="k">def</span> <span class="nf">extract_method</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">words</span><span class="p">.</span><span class="nf">shift</span> <span class="k">unless</span> <span class="n">word</span> <span class="o">=~</span> <span class="sr">/^-X/</span>

      <span class="k">if</span> <span class="o">!</span><span class="p">(</span><span class="nb">method</span> <span class="o">=</span> <span class="n">word</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sr">/^-X(.*)/</span><span class="p">)[</span><span class="mi">1</span><span class="p">]).</span><span class="nf">empty?</span>
        <span class="nb">method</span>
      <span class="k">else</span>
        <span class="n">words</span><span class="p">.</span><span class="nf">shift</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">Authorization</span> <span class="o">&lt;</span> <span class="no">Base</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\A(-u|--user)\Z/</span><span class="p">.</span><span class="nf">freeze</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
      <span class="n">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Authorization'</span><span class="p">]</span> <span class="o">||=</span>
        <span class="s2">"Basic </span><span class="si">#{</span><span class="no">Base64</span><span class="p">.</span><span class="nf">strict_encode64</span><span class="p">(</span><span class="n">words</span><span class="p">.</span><span class="nf">shift</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">Cookie</span> <span class="o">&lt;</span> <span class="no">Base</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\A(-b|--cookie)\Z/</span><span class="p">.</span><span class="nf">freeze</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
      <span class="n">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Set-Cookie'</span><span class="p">]</span> <span class="o">||=</span> <span class="n">words</span><span class="p">.</span><span class="nf">shift</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">UserAgent</span> <span class="o">&lt;</span> <span class="no">Base</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\A(-A|--user-agent)\Z/</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
      <span class="n">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'User-Agent'</span><span class="p">]</span> <span class="o">||=</span> <span class="n">words</span><span class="p">.</span><span class="nf">shift</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">Head</span> <span class="o">&lt;</span> <span class="no">Base</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\A(-I|--head)\Z/</span><span class="p">.</span><span class="nf">freeze</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
      <span class="n">request</span><span class="p">.</span><span class="nf">method</span> <span class="o">=</span> <span class="s1">'HEAD'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">Data</span> <span class="o">&lt;</span> <span class="no">Base</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\A(-d|--data|--data-ascii)\Z/</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">options</span>
      <span class="p">{}</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
      <span class="n">request</span><span class="p">.</span><span class="nf">method</span> <span class="o">=</span> <span class="s1">'POST'</span> <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="nf">method</span> <span class="o">==</span> <span class="s1">'GET'</span> <span class="o">||</span>
                                 <span class="n">request</span><span class="p">.</span><span class="nf">method</span> <span class="o">==</span> <span class="s1">'HEAD'</span>
      <span class="n">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Content-Type'</span><span class="p">]</span> <span class="o">||=</span>
        <span class="s1">'application/x-www-form-urlencoded'</span>

      <span class="n">data</span> <span class="o">=</span> <span class="n">extract_data</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

      <span class="n">request</span><span class="p">.</span><span class="nf">body</span> <span class="o">=</span> <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="nf">body</span><span class="p">.</span><span class="nf">empty?</span>
                       <span class="n">data</span>
                     <span class="k">else</span>
                       <span class="s2">"</span><span class="si">#{</span><span class="n">request</span><span class="p">.</span><span class="nf">body</span><span class="si">}</span><span class="s2">&amp;</span><span class="si">#{</span><span class="n">data</span><span class="si">}</span><span class="s2">"</span>
                     <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">extract_data</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
      <span class="n">data</span> <span class="o">=</span> <span class="n">words</span><span class="p">.</span><span class="nf">shift</span>
      <span class="n">data</span> <span class="o">=</span> <span class="n">read_file</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="k">if</span> <span class="n">data</span> <span class="o">=~</span> <span class="sr">/\A@/</span> <span class="o">||</span>
                                      <span class="n">args</span><span class="p">[</span><span class="ss">:raw</span><span class="p">]</span>
      <span class="n">data</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">read_file</span><span class="p">(</span><span class="n">word</span><span class="p">,</span>
                  <span class="ss">strip_newlines: </span><span class="kp">true</span><span class="p">,</span>
                  <span class="ss">raw: </span><span class="kp">false</span><span class="p">,</span>
                  <span class="ss">url_encode: </span><span class="kp">false</span><span class="p">)</span>
      <span class="n">path</span> <span class="o">=</span> <span class="n">raw</span> <span class="p">?</span> <span class="n">word</span> <span class="p">:</span> <span class="n">word</span><span class="p">[</span><span class="mi">1</span><span class="o">..-</span><span class="mi">1</span><span class="p">]</span>
      <span class="n">content</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
      <span class="n">content</span><span class="p">.</span><span class="nf">gsub!</span><span class="p">(</span><span class="sr">/\n|\r/</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span> <span class="k">if</span> <span class="n">strip_newlines</span>
      <span class="n">content</span> <span class="o">=</span> <span class="no">CGI</span><span class="p">.</span><span class="nf">escape</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="k">if</span> <span class="n">url_encode</span>
      <span class="n">content</span>
    <span class="k">rescue</span> <span class="no">Errno</span><span class="o">::</span><span class="no">ENOENT</span>
      <span class="n">file_path</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">expand_path</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="o">..-</span><span class="mi">1</span><span class="p">])</span>
      <span class="k">raise</span> <span class="no">FileNotFoundError</span><span class="p">,</span>
            <span class="s2">"Cannot read file: </span><span class="si">#{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">. Does it exist?"</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">StripNewlinesData</span> <span class="o">&lt;</span> <span class="no">Data</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\A--data-binary\Z/</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">options</span>
      <span class="p">{</span> <span class="ss">strip_newlines: </span><span class="kp">false</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">RawData</span> <span class="o">&lt;</span> <span class="no">Data</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\A--data-raw\Z/</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">options</span>
      <span class="p">{</span> <span class="ss">raw: </span><span class="kp">true</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">URLEncodeData</span> <span class="o">&lt;</span> <span class="no">Data</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\A--data-urlencode\Z/</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">options</span>
      <span class="p">{</span> <span class="ss">url_encode: </span><span class="kp">true</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">URL</span> <span class="o">&lt;</span> <span class="no">Base</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">===</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
      <span class="n">word</span> <span class="o">=~</span> <span class="no">URI</span><span class="o">::</span><span class="no">DEFAULT_PARSER</span><span class="p">.</span><span class="nf">make_regexp</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
      <span class="n">request</span><span class="p">.</span><span class="nf">url</span> <span class="o">=</span> <span class="n">word</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">NonStrictURL</span> <span class="o">&lt;</span> <span class="no">Base</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\./</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
      <span class="n">request</span><span class="p">.</span><span class="nf">url</span> <span class="o">=</span> <span class="s2">"http://</span><span class="si">#{</span><span class="n">word</span><span class="si">}</span><span class="s2">"</span> <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="nf">url</span> <span class="o">==</span> <span class="s1">''</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Parser</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="vi">@request</span> <span class="o">=</span> <span class="n">request</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">words</span><span class="p">)</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">words</span> <span class="o">=</span> <span class="n">words</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">word</span> <span class="o">=</span> <span class="n">words</span><span class="p">.</span><span class="nf">shift</span><span class="p">)</span>
      <span class="n">parse_word</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="nb">attr_accessor</span> <span class="ss">:words</span>
  <span class="nb">attr_reader</span> <span class="ss">:request</span>

  <span class="k">def</span> <span class="nf">parse_word</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
    <span class="no">Word</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">words</span><span class="p">,</span> <span class="n">word</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>Note how each class contains knowledge specific to the 
argument we&#39;re trying to cover with it and nothing else. I
think that&#39;s an improvement since it&#39;s still easy to 
support new arguments, and we don&#39;t pollute a single class
with many methods.</p>


  <div class='bottom'>
    <section class="author">
      <img src='/public/shime.jpg' alt='' />
      <div>
      <h4>Hrvoje Šimić</h4>
      <p class="bio">
        <a href="https://twitter.com/shime_sh">
          @shime_sh
        </a>

        <small>
          I'm a Ruby developer focused on building MVPs with Ruby on Rails.
        </small>
      </p>
      </div>
    </section>
  </div>
</div>

      </div>
    </div>
  </body>
</html>
