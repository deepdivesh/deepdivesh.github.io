<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="//gmpg.org/xfn/11" rel="profile">

  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    Hrvoje Šimić &middot; Or
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link href="https://fonts.googleapis.com/css?family=Lora|Open+Sans:300,700" rel="stylesheet">

  <!-- Icons -->
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">
</head>


  <body>
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <ul class="masthead-navigation">
            
              <li>
                
                  <a href='/articles'>Articles</a>
                
              </li>
            
              <li>
                
                  <a href='/photography'>Photography</a>
                
              </li>
            
              <li>
                
                  <a href='/reading'>Reading list</a>
                
              </li>
            
          </ul>
        </div>
        <div class="clear"></div>
      </div>

      <div class="container content">
        <div class="post">
  <div class="post-meta">
    <h1 class="post-title">Or</h1>
    <div class="published">
      11 Aug 2018 on
      ruby
    </div>
  </div>
  <p>Imagine you have a following table:</p>

<table>
  <caption><i>users</i></caption>
  <tr>
    <th>id</th>
    <th>email</th>
    <th>first_name</th>
    <th>last_name</th>
  </tr>
  <tr>
    <th scope="row">1</th>
    <td>aurelio.jones@schuster-company.de</td>
    <td>Aurelio</td>
    <td>Jones</td>
  </tr>
  <tr>
    <th scope="row">2</th>
    <td>dakota.berge@herman-company.at</td>
    <td>Dakota</td>
    <td>Berge</td>
  </tr>
  <tr>
    <th scope="row">3</th>
    <td>caterina.schuster@berge-company.dk</td>
    <td>Caterina</td>
    <td>Schuster</td>
  </tr>
  <tr>
    <th scope="row">4</th>
    <td>adriel.herman@jones-company.us</td>
    <td>Adriel</td>
    <td>Herman</td>
  </tr>
</table>

<p>And your next task is to implement a pretty standard
search for all users on the admin portion of the 
web application you&#39;re building. You could go all
Elasticsearch with it, but maybe you don&#39;t want to
add so much complexity and want to ship this feature
as soon as possible.</p>

<p>The search needs to work on all columns and be case
insesitive, of course. You spend some time investigating
the problem and realize you need to implement the <em>or</em>
condition on the query you&#39;ll execute.</p>

<p>The SQL that you need to execute is this:</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span></span><span class="k">SELECT</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="n">users</span>
<span class="k">WHERE</span> <span class="n">email</span> <span class="k">ILIKE</span> <span class="s1">&#39;%#{query}%&#39;</span>
<span class="k">OR</span> <span class="n">first_name</span> <span class="k">ILIKE</span> <span class="s1">&#39;%#{query}%&#39;</span>
<span class="k">OR</span> <span class="n">last_name</span> <span class="k">ILIKE</span> <span class="s1">&#39;%#{query}%&#39;</span>
</code></pre></div>
<p>Where <em>query</em> is the string inputed in the search box.
Now, you could go hardcore and just do it by
writing a raw SQL.</p>

<p>With Active Record, this would look like this:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
  <span class="n">query</span> <span class="o">=</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="s2">&quot;%</span><span class="si">#{</span><span class="n">query</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

  <span class="n">sql</span> <span class="o">=</span> <span class="o">&lt;&lt;-</span><span class="dl">SQL</span>
<span class="sh">    SELECT *</span>
<span class="sh">    FROM users</span>
<span class="sh">    WHERE email ILIKE #{query}</span>
<span class="sh">    OR first_name ILIKE #{query}</span>
<span class="sh">    OR last_name ILIKE #{query}</span>
<span class="dl">  SQL</span>

  <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">exec_query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">search</span><span class="p">(</span><span class="s2">&quot;schuster&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rows</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">row</span><span class="o">|</span> <span class="n">row</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">}</span> <span class="c1"># [1, 3]</span>
</code></pre></div>
<p>You realize you don&#39;t want to write a raw SQL like this,
though. It&#39;s hard for people to maintain and it doesn&#39;t
return the desired <em>User</em> instances. It returns the 
hardcore array of values, which you then have to parse
and convert to instances of <em>User</em>. Hey, that&#39;s what ORMs do!</p>

<p>Why not use the ORM? Easy peasy! You spend a couple of hours
and come up with this monstrosity.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
  <span class="n">columns</span> <span class="o">=</span> <span class="o">[</span><span class="ss">:first_name</span><span class="p">,</span> <span class="ss">:last_name</span><span class="p">,</span> <span class="ss">:email</span><span class="o">]</span>
  <span class="no">User</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">columns</span><span class="o">.</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">column</span><span class="o">|</span>
    <span class="no">Arel</span><span class="o">::</span><span class="no">Nodes</span><span class="o">::</span><span class="no">InfixOperation</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;ILIKE&#39;</span><span class="p">,</span> <span class="no">User</span><span class="o">.</span><span class="n">arel_table</span><span class="o">[</span><span class="n">column</span><span class="o">]</span><span class="p">,</span> <span class="no">Arel</span><span class="o">::</span><span class="no">Nodes</span><span class="o">.</span><span class="n">build_quoted</span><span class="p">(</span><span class="s2">&quot;%</span><span class="si">#{</span><span class="n">query</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">))</span>
  <span class="k">end</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="ss">:or</span><span class="p">))</span>
<span class="k">end</span>

<span class="n">search</span><span class="p">(</span><span class="s2">&quot;schuster&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:id</span><span class="p">)</span> <span class="c1"># [1, 3]</span>
</code></pre></div>
<p>Yes, you went one level deeper. Active Record is just too simple, everyone knows it, why not
dig a little deeper.</p>

<p>You can&#39;t sleep. You&#39;re worried what will happen if some requirement about the user
search changes. Who will understand your Arel monstrosity? You&#39;re spinning in your bed, sweating.
Suddenly, an owl crashes into your window. There&#39;s an envelope. You open it - &quot;They&#39;ve added <em>or</em> in Rails 5, you&#39;ve been living under a rock.&quot;</p>

<p>&quot;Oh&quot;, you think, &quot;neat!&quot;. Now it&#39;s really easy peasy!</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
  <span class="no">User</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;first_name ILIKE ?&quot;</span><span class="p">,</span> <span class="s2">&quot;%</span><span class="si">#{</span><span class="n">term</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span><span class="o">.</span>
       <span class="ow">or</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;last_name ILIKE ?&quot;</span><span class="p">,</span> <span class="s2">&quot;%</span><span class="si">#{</span><span class="n">term</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">))</span><span class="o">.</span>
       <span class="ow">or</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;email ILIKE ?&quot;</span><span class="p">,</span> <span class="s2">&quot;%</span><span class="si">#{</span><span class="n">term</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">))</span>
<span class="k">end</span>

<span class="n">search</span><span class="p">(</span><span class="s2">&quot;schuster&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:id</span><span class="p">)</span> <span class="c1"># [1, 3]</span>
</code></pre></div>
<p>Yippy! You finally did it. No raw SQL, no scary Arel, just Active Record, plain and simple.
Congratulations!  Let&#39;s celebrate with some good old TV! You turn it on, and suddenly
a freaking commercial starts. </p>

<p>&quot;Worried you&#39;re wasting your life on Active Record? Feeling you&#39;re wasted your youth on Rails and
it&#39;s convetions? The grass is always greener on the other side! Try Sequel today and get your
youth back. It&#39;s simple as a-b-c.&quot;</p>

<p>Hmmm, intriguing! You spend some time investigating this Sequel thing. 
Finally, you come up with this:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
  <span class="no">User</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="no">Sequel</span><span class="o">.</span><span class="n">ilike</span><span class="p">(</span><span class="ss">:email</span><span class="p">,</span> <span class="s2">&quot;%</span><span class="si">#{</span><span class="n">term</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span> <span class="o">|</span>
             <span class="no">Sequel</span><span class="o">.</span><span class="n">ilike</span><span class="p">(</span><span class="ss">:first_name</span><span class="p">,</span> <span class="s2">&quot;%</span><span class="si">#{</span><span class="n">term</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span> <span class="o">|</span>
             <span class="no">Sequel</span><span class="o">.</span><span class="n">ilike</span><span class="p">(</span><span class="ss">:last_name</span><span class="p">,</span> <span class="s2">&quot;%</span><span class="si">#{</span><span class="n">term</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">))</span>
<span class="k">end</span>

<span class="n">search</span><span class="p">(</span><span class="s2">&quot;schuster&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:id</span><span class="p">)</span> <span class="c1"># [1, 3]</span>
</code></pre></div>
<p>That&#39;s it. You&#39;ve had enough.</p>


  <div class='bottom'>
    <h5 class="writtenby"><span>Written by</span></h5>
    <section class="author">
      <h4>Hrvoje Šimić</h4>
      <p class="bio">
        <a href="https://twitter.com/shime_sh">
          @shime_sh
        </a>
      </p>
      <hr>
    </section>
  </div>
</div>

      </div>
    </div>
  </body>
</html>
