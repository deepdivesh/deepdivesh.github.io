<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="//gmpg.org/xfn/11" rel="profile">

  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/monokai.css?1582830008441526000">
  <link rel="stylesheet" href="/public/css/style.css?1582830008441526000">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">

  <!-- Begin Jekyll SEO tag v2.6.1 -->
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Deep dive into Did You Mean" />
<meta name="author" content="Hrvoje Šimić" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="License (MIT) (The MIT License) Copyright (c) 2014-2016 Yuki Nishijima" />
<meta property="og:description" content="License (MIT) (The MIT License) Copyright (c) 2014-2016 Yuki Nishijima" />
<link rel="canonical" href="https://deepdive.sh/deep-dive-into-did-you-mean" />
<meta property="og:url" content="https://deepdive.sh/deep-dive-into-did-you-mean" />
<meta property="og:site_name" content="Deep Dive" />
<meta property="og:image" content="https://deepdive.sh/public/social3.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-12-28T00:00:00+01:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:image" content="https://deepdive.sh/public/social3.jpg" />
<meta property="twitter:title" content="Deep dive into Did You Mean" />
<meta name="twitter:site" content="@shime_sh" />
<meta name="twitter:creator" content="@shime_sh" />
<script type="application/ld+json">
{"dateModified":"2019-12-28T00:00:00+01:00","datePublished":"2019-12-28T00:00:00+01:00","url":"https://deepdive.sh/deep-dive-into-did-you-mean","headline":"Deep dive into Did You Mean","mainEntityOfPage":{"@type":"WebPage","@id":"https://deepdive.sh/deep-dive-into-did-you-mean"},"image":"https://deepdive.sh/public/social3.jpg","author":{"@type":"Person","name":"Hrvoje Šimić"},"description":"License (MIT) (The MIT License) Copyright (c) 2014-2016 Yuki Nishijima","@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  
    <title> Deep dive into Did You Mean &middot; Deep Dive </title>
  

  <meta name="title" content="Deep dive into Did You Mean &middot; Deep Dive">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.0/anchor.min.js"></script>
</head>


  <body class="font-sans">
    <div class="lg:pt-16 lg:pb-32 p-6 relative">
      <div class="relative flex justify-between items-start w-full z-20 md:justify-center self-center">
  <div class="max-w-sm">
    <a href="/">
      <img src="/public/deep_dive.png" />
    </a>
  </div>
</div>


      <div class="w-full flex justify-center text-lg mt-16 text-grey-darker font-light leading-normal">
        <div class="post max-w-full md:max-w-md">
          
          

          <div>
            <a class="no-underline uppercase text-sm" href="/"> ← articles </a>
          </div>
          <div class="mb-8">
            <h1>Deep dive into Did You Mean</h1>
            
            <div class="text-grey">
              December 28, 2019
            </div>
            

            <div class="flex my-2">
              
                <span class="bg-blue-lightest py-1 px-2 text-center text-blue-dark mr-2 rounded text-sm">
                  ruby
                </span>
              
            </div>
          </div>

          <details><summary class="cursor-pointer outline-none">License (MIT)</summary>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span><span class="o">(</span>The MIT License<span class="o">)</span>
Copyright <span class="o">(</span>c<span class="o">)</span> <span class="m">2014</span>-2016 Yuki Nishijima

MIT License

Permission is hereby granted, free of charge, to any person obtaining
a copy of this software and associated documentation files <span class="o">(</span>the
<span class="s2">&quot;Software&quot;</span><span class="o">)</span>, to deal in the Software without restriction, including
without limitation the rights to use, copy, modify, merge, publish,
distribute, sublicense, and/or sell copies of the Software, and to
permit persons to whom the Software is furnished to <span class="k">do</span> so, subject to
the following conditions:

The above copyright notice and this permission notice shall be
included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED <span class="s2">&quot;AS IS&quot;</span>, WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</code></pre></figure>

</details>

<p>Since version 2.3.0, Ruby comes bundled
with <a href="https://github.com/ruby/did_you_mean">did_you_mean</a>,
a handy gem for detecting typos.</p>

<p>Running this snippet of code:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="k">def</span> <span class="nf">greet</span>
  <span class="s2">&quot;hello!&quot;</span>
<span class="k">end</span>

<span class="n">greeet</span>
</code></pre></div>
<p>Will produce the following error message:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>Traceback (most recent call last):
fun.rb:5:in `&lt;main&gt;&#39;: undefined local variable or method
                      `greeet&#39; for main:Object (NameError)
Did you mean?  greet
</code></pre></div>
<p>The bottom part of that error message was produced by
Did You Mean.</p>

<p>Let&#39;s re-implement the functionality provided by the
gem in order to figure out how it works.</p>

<h2>Reinvent the wheel</h2>

<p>The error message produced contains the standard <code>NameError</code>
message, with an additional question for the typo. Let&#39;s try
to do the same thing for the <code>ZeroDivisionError</code>.</p>

<p>This snippet of code:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="mi">1</span> <span class="o">/</span> <span class="mi">0</span>
</code></pre></div>
<p>Will produce the following error message:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>Traceback (most recent call last):
        1: from fun.rb:1:in `&lt;main&gt;&#39;
fun.rb:1:in `/&#39;: divided by 0 (ZeroDivisionError)
</code></pre></div>
<p>Overriding the <code>to_s</code> instance method of the error class,
enables error message customizations. Let&#39;s customize
the <code>ZeroDivisionError</code> message to include custom
text:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="k">class</span> <span class="nc">ZeroDivisionError</span>
  <span class="k">def</span> <span class="nf">to_s</span>
    <span class="s2">&quot;</span><span class="si">#{</span><span class="k">super</span><span class="si">}</span><span class="se">\n</span><span class="s2">Oops, this looks like infinity to me.&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="mi">1</span> <span class="o">/</span> <span class="mi">0</span>
</code></pre></div>
<p>Running this will produce:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>Traceback (most recent call last):
        1: from fun.rb:7:in `&lt;main&gt;&#39;
fun.rb:7:in `/&#39;: divided by 0 (ZeroDivisionError)
Oops, this looks like infinity to me.
</code></pre></div>
<p>This is a very simplified version of what Did You Mean
does under the hood, so let&#39;s dive right in.</p>

<h2>Look under the hood</h2>

<p>Let&#39;s look into the internals
of this gem:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>git clone git@github.com:ruby/did_you_mean.git
cd did_you_mean
git checkout 8175f6e
</code></pre></div>
<p>Let&#39;s confirm our hunch that <code>to_s</code> is being overriden
somewhere:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>grep &quot;def to_s&quot; -nR lib
</code></pre></div>
<p>Which leads us to the following:</p>

<figure class="highlight"><div class='source-location'>
          <a href='https://github.com/ruby/did_you_mean/blob/8175f6eefb9c55a8906fc8bce2dd3b7c03de3e59/lib/did_you_mean/core_ext/name_error.rb'>
            lib/did_you_mean/core_ext/name_error.rb &nearr;
          </a>
        </div><pre><code class="language-ruby" data-lang="ruby"><div class="emphasized"><pre><span></span><span class="k">module</span> <span class="nn">DidYouMean</span>
  <span class="k">module</span> <span class="nn">Correctable</span>
    <span class="k">def</span> <span class="nf">original_message</span>
      <span class="nb">method</span><span class="p">(</span><span class="ss">:to_s</span><span class="p">)</span><span class="o">.</span><span class="n">super_method</span><span class="o">.</span><span class="n">call</span>
    <span class="k">end</span>

<span class="hll">    <span class="k">def</span> <span class="nf">to_s</span>
</span><span class="hll">      <span class="n">msg</span> <span class="o">=</span> <span class="k">super</span><span class="o">.</span><span class="n">dup</span>
</span><span class="hll">      <span class="n">suggestion</span> <span class="o">=</span> <span class="no">DidYouMean</span><span class="o">.</span><span class="n">formatter</span><span class="o">.</span><span class="n">message_for</span><span class="p">(</span><span class="n">corrections</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">      <span class="n">msg</span> <span class="o">&lt;&lt;</span> <span class="n">suggestion</span> <span class="k">if</span> <span class="o">!</span><span class="n">msg</span><span class="o">.</span><span class="n">end_with?</span><span class="p">(</span><span class="n">suggestion</span><span class="p">)</span>
</span><span class="hll">      <span class="n">msg</span>
</span><span class="hll">    <span class="k">rescue</span>
</span><span class="hll">      <span class="k">super</span>
</span><span class="hll">    <span class="k">end</span>
</span><span class="hll">
</span><span class="hll">    <span class="k">def</span> <span class="nf">corrections</span>
</span><span class="hll">      <span class="vi">@corrections</span> <span class="o">||=</span> <span class="n">spell_checker</span><span class="o">.</span><span class="n">corrections</span>
</span><span class="hll">    <span class="k">end</span>
</span><span class="hll">
</span><span class="hll">    <span class="k">def</span> <span class="nf">spell_checker</span>
</span><span class="hll">      <span class="no">SPELL_CHECKERS</span><span class="o">[</span><span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">to_s</span><span class="o">].</span><span class="n">new</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
</span><span class="hll">    <span class="k">end</span>
</span>  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>Looks like we&#39;re fetching a spell checker for this type of error:</p>

<figure class="highlight"><div class='source-location'>
          <a href='https://github.com/ruby/did_you_mean/blob/8175f6eefb9c55a8906fc8bce2dd3b7c03de3e59/lib/did_you_mean/core_ext/name_error.rb'>
            lib/did_you_mean/core_ext/name_error.rb &nearr;
          </a>
        </div><pre><code class="language-ruby" data-lang="ruby"><div class="emphasized"><pre><span></span><span class="k">module</span> <span class="nn">DidYouMean</span>
  <span class="k">module</span> <span class="nn">Correctable</span>
    <span class="k">def</span> <span class="nf">original_message</span>
      <span class="nb">method</span><span class="p">(</span><span class="ss">:to_s</span><span class="p">)</span><span class="o">.</span><span class="n">super_method</span><span class="o">.</span><span class="n">call</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">to_s</span>
      <span class="n">msg</span> <span class="o">=</span> <span class="k">super</span><span class="o">.</span><span class="n">dup</span>
      <span class="n">suggestion</span> <span class="o">=</span> <span class="no">DidYouMean</span><span class="o">.</span><span class="n">formatter</span><span class="o">.</span><span class="n">message_for</span><span class="p">(</span><span class="n">corrections</span><span class="p">)</span>

      <span class="n">msg</span> <span class="o">&lt;&lt;</span> <span class="n">suggestion</span> <span class="k">if</span> <span class="o">!</span><span class="n">msg</span><span class="o">.</span><span class="n">end_with?</span><span class="p">(</span><span class="n">suggestion</span><span class="p">)</span>
      <span class="n">msg</span>
    <span class="k">rescue</span>
      <span class="k">super</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">corrections</span>
      <span class="vi">@corrections</span> <span class="o">||=</span> <span class="n">spell_checker</span><span class="o">.</span><span class="n">corrections</span>
    <span class="k">end</span>

<span class="hll">    <span class="k">def</span> <span class="nf">spell_checker</span>
</span><span class="hll">      <span class="no">SPELL_CHECKERS</span><span class="o">[</span><span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">to_s</span><span class="o">].</span><span class="n">new</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
</span><span class="hll">    <span class="k">end</span>
</span>  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>Spell checkers are being set in the entry file:</p>

<figure class="highlight"><div class='source-location'>
          <a href='https://github.com/ruby/did_you_mean/blob/8175f6eefb9c55a8906fc8bce2dd3b7c03de3e59/lib/did_you_mean.rb#L85-L110'>
            lib/did_you_mean.rb#L85-L110 &nearr;
          </a>
        </div><pre><code class="language-ruby" data-lang="ruby"><div class="emphasized"><pre><span></span><span class="k">module</span> <span class="nn">DidYouMean</span>
<span class="hll">  <span class="c1"># Map of error types and spell checker objects.</span>
</span><span class="hll">  <span class="no">SPELL_CHECKERS</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">NullChecker</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Adds +DidYouMean+ functionality to an error using a given spell checker</span>
</span><span class="hll">  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">correct_error</span><span class="p">(</span><span class="n">error_class</span><span class="p">,</span> <span class="n">spell_checker</span><span class="p">)</span>
</span><span class="hll">    <span class="no">SPELL_CHECKERS</span><span class="o">[</span><span class="n">error_class</span><span class="o">.</span><span class="n">name</span><span class="o">]</span> <span class="o">=</span> <span class="n">spell_checker</span>
</span><span class="hll">    <span class="n">error_class</span><span class="o">.</span><span class="n">prepend</span><span class="p">(</span><span class="no">Correctable</span><span class="p">)</span> <span class="k">unless</span> <span class="n">error_class</span> <span class="o">&lt;</span> <span class="no">Correctable</span>
</span><span class="hll">  <span class="k">end</span>
</span><span class="hll">
</span><span class="hll">  <span class="n">correct_error</span> <span class="no">NameError</span><span class="p">,</span> <span class="no">NameErrorCheckers</span>
</span><span class="hll">  <span class="n">correct_error</span> <span class="no">KeyError</span><span class="p">,</span> <span class="no">KeyErrorChecker</span>
</span><span class="hll">  <span class="n">correct_error</span> <span class="no">NoMethodError</span><span class="p">,</span> <span class="no">MethodNameChecker</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Returns the currenctly set formatter. By default, it is set to +DidYouMean::Formatter+.</span>
</span>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">formatter</span>
    <span class="vc">@@formatter</span>
  <span class="k">end</span>

  <span class="c1"># Updates the primary formatter used to format the suggestions.</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">formatter</span><span class="o">=</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
    <span class="vc">@@formatter</span> <span class="o">=</span> <span class="n">formatter</span>
  <span class="k">end</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">formatter</span> <span class="o">=</span> <span class="no">PlainFormatter</span><span class="o">.</span><span class="n">new</span>
<span class="k">end</span></code></pre></figure>

<p>This is a pretty elegant piece of code. </p>

<p>The class method <code>DidYouMean.correct_error</code> not only
populates the <code>SPELL_CHECKERS</code> hash with the spell checker for each error class,
but also prepends <code>Correctable</code>. Since we&#39;ve got here by investigating what is <code>SPELL_CHECKERS</code>,
we now know this:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="no">SPELL_CHECKERS</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s2">&quot;NameError&quot;</span> <span class="o">=&gt;</span> <span class="no">NameErrorCheckers</span><span class="p">,</span>
  <span class="s2">&quot;KeyError&quot;</span> <span class="o">=&gt;</span> <span class="no">KeyErrorCheckers</span><span class="p">,</span>
  <span class="s2">&quot;NoMethodError&quot;</span> <span class="o">=&gt;</span> <span class="no">MethodNameChecker</span>
<span class="p">}</span>
</code></pre></div>
<p>Since Did You Mean is doing different things for these error
classes, let&#39;s assume that we have spelled a method name wrong
and <code>NoMethodError</code> was raised. Did You Mean is going to
use <code>MethodNameChecker</code> for this.</p>

<p>Since <code>Correctable</code> is retrieving corrections from spell checker:</p>

<figure class="highlight"><div class='source-location'>
          <a href='https://github.com/ruby/did_you_mean/blob/8175f6eefb9c55a8906fc8bce2dd3b7c03de3e59/lib/did_you_mean/core_ext/name_error.rb'>
            lib/did_you_mean/core_ext/name_error.rb &nearr;
          </a>
        </div><pre><code class="language-ruby" data-lang="ruby"><div class="emphasized"><pre><span></span><span class="k">module</span> <span class="nn">DidYouMean</span>
  <span class="k">module</span> <span class="nn">Correctable</span>
    <span class="k">def</span> <span class="nf">original_message</span>
      <span class="nb">method</span><span class="p">(</span><span class="ss">:to_s</span><span class="p">)</span><span class="o">.</span><span class="n">super_method</span><span class="o">.</span><span class="n">call</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">to_s</span>
      <span class="n">msg</span> <span class="o">=</span> <span class="k">super</span><span class="o">.</span><span class="n">dup</span>
<span class="hll">      <span class="n">suggestion</span> <span class="o">=</span> <span class="no">DidYouMean</span><span class="o">.</span><span class="n">formatter</span><span class="o">.</span><span class="n">message_for</span><span class="p">(</span><span class="n">corrections</span><span class="p">)</span>
</span>
      <span class="n">msg</span> <span class="o">&lt;&lt;</span> <span class="n">suggestion</span> <span class="k">if</span> <span class="o">!</span><span class="n">msg</span><span class="o">.</span><span class="n">end_with?</span><span class="p">(</span><span class="n">suggestion</span><span class="p">)</span>
      <span class="n">msg</span>
    <span class="k">rescue</span>
      <span class="k">super</span>
    <span class="k">end</span>

<span class="hll">    <span class="k">def</span> <span class="nf">corrections</span>
</span><span class="hll">      <span class="vi">@corrections</span> <span class="o">||=</span> <span class="n">spell_checker</span><span class="o">.</span><span class="n">corrections</span>
</span><span class="hll">    <span class="k">end</span>
</span>
    <span class="k">def</span> <span class="nf">spell_checker</span>
      <span class="no">SPELL_CHECKERS</span><span class="o">[</span><span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">to_s</span><span class="o">].</span><span class="n">new</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>Let&#39;s dive into <code>MethodNameChecker#corrections</code>:</p>

<figure class="highlight"><div class='source-location'>
          <a href='https://github.com/ruby/did_you_mean/blob/8175f6eefb9c55a8906fc8bce2dd3b7c03de3e59/lib/did_you_mean/spell_checkers/method_name_checker.rb'>
            lib/did_you_mean/spell_checkers/method_name_checker.rb &nearr;
          </a>
        </div><pre><code class="language-ruby" data-lang="ruby"><div class="emphasized"><pre><span></span><span class="n">require_relative</span> <span class="s2">&quot;../spell_checker&quot;</span>

<span class="k">module</span> <span class="nn">DidYouMean</span>
  <span class="k">class</span> <span class="nc">MethodNameChecker</span>
    <span class="kp">attr_reader</span> <span class="ss">:method_name</span><span class="p">,</span> <span class="ss">:receiver</span>

    <span class="no">NAMES_TO_EXCLUDE</span> <span class="o">=</span> <span class="p">{</span> <span class="no">NilClass</span> <span class="o">=&gt;</span> <span class="kp">nil</span><span class="o">.</span><span class="n">methods</span> <span class="p">}</span>
    <span class="no">NAMES_TO_EXCLUDE</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="o">[]</span>

    <span class="c1"># +MethodNameChecker::RB_RESERVED_WORDS+ is the list of reserved words in</span>
    <span class="c1"># Ruby that take an argument. Unlike</span>
    <span class="c1"># +VariableNameChecker::RB_RESERVED_WORDS+, these reserved words require</span>
    <span class="c1"># an argument, and a +NoMethodError+ is raised due to the presence of the</span>
    <span class="c1"># argument.</span>
    <span class="c1">#</span>
    <span class="c1"># The +MethodNameChecker+ will use this list to suggest a reversed word if</span>
    <span class="c1"># a +NoMethodError+ is raised and found closest matches.</span>
    <span class="c1">#</span>
    <span class="c1"># Also see +VariableNameChecker::RB_RESERVED_WORDS+.</span>
    <span class="no">RB_RESERVED_WORDS</span> <span class="o">=</span> <span class="o">%</span><span class="n">i</span><span class="p">(</span>
      <span class="k">alias</span>
      <span class="k">case</span>
      <span class="k">def</span>
      <span class="nf">defined?</span>
      <span class="k">elsif</span>
      <span class="k">end</span>
      <span class="k">ensure</span>
      <span class="k">for</span>
      <span class="k">rescue</span>
      <span class="k">super</span>
      <span class="k">undef</span>
      <span class="k">unless</span>
      <span class="k">until</span>
      <span class="k">when</span>
      <span class="k">while</span>
      <span class="k">yield</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">exception</span><span class="p">)</span>
      <span class="vi">@method_name</span>  <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">name</span>
      <span class="vi">@receiver</span>     <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">receiver</span>
      <span class="vi">@private_call</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:private_call?</span><span class="p">)</span> <span class="p">?</span> <span class="n">exception</span><span class="o">.</span><span class="n">private_call?</span> <span class="p">:</span> <span class="kp">false</span>
    <span class="k">end</span>

<span class="hll">    <span class="k">def</span> <span class="nf">corrections</span>
</span><span class="hll">      <span class="vi">@corrections</span> <span class="o">||=</span> <span class="no">SpellChecker</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">dictionary</span><span class="p">:</span> <span class="no">RB_RESERVED_WORDS</span> <span class="o">+</span> <span class="n">method_names</span><span class="p">)</span><span class="o">.</span><span class="n">correct</span><span class="p">(</span><span class="n">method_name</span><span class="p">)</span> <span class="o">-</span> <span class="no">NAMES_TO_EXCLUDE</span><span class="o">[</span><span class="vi">@receiver</span><span class="o">.</span><span class="n">class</span><span class="o">]</span>
</span><span class="hll">    <span class="k">end</span>
</span>
    <span class="k">def</span> <span class="nf">method_names</span>
      <span class="n">method_names</span> <span class="o">=</span> <span class="n">receiver</span><span class="o">.</span><span class="n">methods</span> <span class="o">+</span> <span class="n">receiver</span><span class="o">.</span><span class="n">singleton_methods</span>
      <span class="n">method_names</span> <span class="o">+=</span> <span class="n">receiver</span><span class="o">.</span><span class="n">private_methods</span> <span class="k">if</span> <span class="vi">@private_call</span>
      <span class="n">method_names</span><span class="o">.</span><span class="n">uniq!</span>
      <span class="n">method_names</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>For our case, this checker is initialized with an instance of <code>NoMethodError</code>. Method names
are collected elegantly by combining <code>Object#methods</code> and <code>Object#signleton_methods</code> on
<a href="https://ruby-doc.org/core-2.7.0.preview3/NameError.html#method-i-receiver">NameError#receiver</a>:</p>

<figure class="highlight"><div class='source-location'>
          <a href='https://github.com/ruby/did_you_mean/blob/8175f6eefb9c55a8906fc8bce2dd3b7c03de3e59/lib/did_you_mean/spell_checkers/method_name_checker.rb'>
            lib/did_you_mean/spell_checkers/method_name_checker.rb &nearr;
          </a>
        </div><pre><code class="language-ruby" data-lang="ruby"><div class="emphasized"><pre><span></span><span class="n">require_relative</span> <span class="s2">&quot;../spell_checker&quot;</span>

<span class="k">module</span> <span class="nn">DidYouMean</span>
  <span class="k">class</span> <span class="nc">MethodNameChecker</span>
    <span class="kp">attr_reader</span> <span class="ss">:method_name</span><span class="p">,</span> <span class="ss">:receiver</span>

    <span class="no">NAMES_TO_EXCLUDE</span> <span class="o">=</span> <span class="p">{</span> <span class="no">NilClass</span> <span class="o">=&gt;</span> <span class="kp">nil</span><span class="o">.</span><span class="n">methods</span> <span class="p">}</span>
    <span class="no">NAMES_TO_EXCLUDE</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="o">[]</span>

    <span class="c1"># +MethodNameChecker::RB_RESERVED_WORDS+ is the list of reserved words in</span>
    <span class="c1"># Ruby that take an argument. Unlike</span>
    <span class="c1"># +VariableNameChecker::RB_RESERVED_WORDS+, these reserved words require</span>
    <span class="c1"># an argument, and a +NoMethodError+ is raised due to the presence of the</span>
    <span class="c1"># argument.</span>
    <span class="c1">#</span>
    <span class="c1"># The +MethodNameChecker+ will use this list to suggest a reversed word if</span>
    <span class="c1"># a +NoMethodError+ is raised and found closest matches.</span>
    <span class="c1">#</span>
    <span class="c1"># Also see +VariableNameChecker::RB_RESERVED_WORDS+.</span>
    <span class="no">RB_RESERVED_WORDS</span> <span class="o">=</span> <span class="o">%</span><span class="n">i</span><span class="p">(</span>
      <span class="k">alias</span>
      <span class="k">case</span>
      <span class="k">def</span>
      <span class="nf">defined?</span>
      <span class="k">elsif</span>
      <span class="k">end</span>
      <span class="k">ensure</span>
      <span class="k">for</span>
      <span class="k">rescue</span>
      <span class="k">super</span>
      <span class="k">undef</span>
      <span class="k">unless</span>
      <span class="k">until</span>
      <span class="k">when</span>
      <span class="k">while</span>
      <span class="k">yield</span>
    <span class="p">)</span>

<span class="hll">    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">exception</span><span class="p">)</span>
</span><span class="hll">      <span class="vi">@method_name</span>  <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">name</span>
</span><span class="hll">      <span class="vi">@receiver</span>     <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">receiver</span>
</span><span class="hll">      <span class="vi">@private_call</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:private_call?</span><span class="p">)</span> <span class="p">?</span> <span class="n">exception</span><span class="o">.</span><span class="n">private_call?</span> <span class="p">:</span> <span class="kp">false</span>
</span><span class="hll">    <span class="k">end</span>
</span><span class="hll">
</span><span class="hll">    <span class="k">def</span> <span class="nf">corrections</span>
</span><span class="hll">      <span class="vi">@corrections</span> <span class="o">||=</span> <span class="no">SpellChecker</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">dictionary</span><span class="p">:</span> <span class="no">RB_RESERVED_WORDS</span> <span class="o">+</span> <span class="n">method_names</span><span class="p">)</span><span class="o">.</span><span class="n">correct</span><span class="p">(</span><span class="n">method_name</span><span class="p">)</span> <span class="o">-</span> <span class="no">NAMES_TO_EXCLUDE</span><span class="o">[</span><span class="vi">@receiver</span><span class="o">.</span><span class="n">class</span><span class="o">]</span>
</span><span class="hll">    <span class="k">end</span>
</span><span class="hll">
</span><span class="hll">    <span class="k">def</span> <span class="nf">method_names</span>
</span><span class="hll">      <span class="n">method_names</span> <span class="o">=</span> <span class="n">receiver</span><span class="o">.</span><span class="n">methods</span> <span class="o">+</span> <span class="n">receiver</span><span class="o">.</span><span class="n">singleton_methods</span>
</span><span class="hll">      <span class="n">method_names</span> <span class="o">+=</span> <span class="n">receiver</span><span class="o">.</span><span class="n">private_methods</span> <span class="k">if</span> <span class="vi">@private_call</span>
</span><span class="hll">      <span class="n">method_names</span><span class="o">.</span><span class="n">uniq!</span>
</span><span class="hll">      <span class="n">method_names</span>
</span><span class="hll">    <span class="k">end</span>
</span>  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p><code>SpellChecker</code> is initialized with a dictionary that contains Ruby&#39;s reserved
words and all of the methods from the receiver, or the object that raised the exception.</p>

<p>Let&#39;s dive into the internals of <code>SpellChecker</code>:</p>

<figure class="highlight"><div class='source-location'>
          <a href='https://github.com/yuki24/did_you_mean/blob/8175f6eefb9c55a8906fc8bce2dd3b7c03de3e59/lib/did_you_mean/spell_checker.rb'>
            lib/did_you_mean/spell_checker.rb &nearr;
          </a>
        </div><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="n">require_relative</span> <span class="s2">&quot;levenshtein&quot;</span>
<span class="n">require_relative</span> <span class="s2">&quot;jaro_winkler&quot;</span>

<span class="k">module</span> <span class="nn">DidYouMean</span>
  <span class="k">class</span> <span class="nc">SpellChecker</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="ss">dictionary</span><span class="p">:)</span>
      <span class="vi">@dictionary</span> <span class="o">=</span> <span class="n">dictionary</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">correct</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
      <span class="n">input</span>     <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
      <span class="n">threshold</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">?</span> <span class="mi">0</span><span class="o">.</span><span class="mi">834</span> <span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">77</span>

      <span class="n">words</span> <span class="o">=</span> <span class="vi">@dictionary</span><span class="o">.</span><span class="n">select</span> <span class="k">do</span> <span class="o">|</span><span class="n">word</span><span class="o">|</span>
        <span class="no">JaroWinkler</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">normalize</span><span class="p">(</span><span class="n">word</span><span class="p">),</span> <span class="n">input</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">threshold</span>
      <span class="k">end</span>
      <span class="n">words</span><span class="o">.</span><span class="n">reject!</span> <span class="p">{</span> <span class="o">|</span><span class="n">word</span><span class="o">|</span> <span class="n">input</span> <span class="o">==</span> <span class="n">word</span><span class="o">.</span><span class="n">to_s</span> <span class="p">}</span>
      <span class="n">words</span><span class="o">.</span><span class="n">sort_by!</span> <span class="p">{</span> <span class="o">|</span><span class="n">word</span><span class="o">|</span> <span class="no">JaroWinkler</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">word</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span> <span class="n">input</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">words</span><span class="o">.</span><span class="n">reverse!</span>

      <span class="c1"># Correct mistypes</span>
      <span class="n">threshold</span>   <span class="o">=</span> <span class="p">(</span><span class="n">input</span><span class="o">.</span><span class="n">length</span> <span class="o">*</span> <span class="mi">0</span><span class="o">.</span><span class="mi">25</span><span class="p">)</span><span class="o">.</span><span class="n">ceil</span>
      <span class="n">corrections</span> <span class="o">=</span> <span class="n">words</span><span class="o">.</span><span class="n">select</span> <span class="k">do</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span>
        <span class="no">Levenshtein</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">normalize</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="n">input</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">threshold</span>
      <span class="k">end</span>

      <span class="c1"># Correct misspells</span>
      <span class="k">if</span> <span class="n">corrections</span><span class="o">.</span><span class="n">empty?</span>
        <span class="n">corrections</span> <span class="o">=</span> <span class="n">words</span><span class="o">.</span><span class="n">select</span> <span class="k">do</span> <span class="o">|</span><span class="n">word</span><span class="o">|</span>
          <span class="n">word</span>   <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
          <span class="n">length</span> <span class="o">=</span> <span class="k">if</span> <span class="n">input</span><span class="o">.</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">word</span><span class="o">.</span><span class="n">length</span> 
                     <span class="n">input</span><span class="o">.</span><span class="n">length</span> 
                   <span class="k">else</span>
                     <span class="n">word</span><span class="o">.</span><span class="n">length</span>
                   <span class="k">end</span>

          <span class="no">Levenshtein</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">input</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">length</span>
        <span class="k">end</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">corrections</span>
    <span class="k">end</span>

    <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">normalize</span><span class="p">(</span><span class="n">str_or_symbol</span><span class="p">)</span> <span class="c1">#:nodoc:</span>
      <span class="n">str</span> <span class="o">=</span> <span class="n">str_or_symbol</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">downcase</span>
      <span class="n">str</span><span class="o">.</span><span class="n">tr!</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
      <span class="n">str</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>Spell checker calculates two distances for detecting word similarities:</p>

<ul>
<li>Jaro-Winkler distance - metric measuring an edit distance between two words</li>
<li>Levenshtein distance - metric measuring the difference between two words</li>
</ul>

<h2>Jaro-Winkler distance</h2>

<p>This metric gives us a number called edit distance representing the similarity between two words:</p>

<ul>
<li>0 means no similarity</li>
<li>1 means that they are identical</li>
</ul>

<p>Edit distance is calculated by counting the minimum number of operations required to transform one string into the other.</p>

<p>Original algorithm is called &quot;Jaro Similarity&quot; and &quot;Jaro-Winkler&quot; is an improvement of that,
giving more favorable rating to the similarity of the beginning of compared words.</p>

<p>I will not go into too much detail about how this algorithm works, but here&#39;s an example for using it
to suggest correct band names:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="no">DICTIONARY</span> <span class="o">=</span> <span class="o">[</span>
  <span class="s2">&quot;the beatles&quot;</span><span class="p">,</span>
  <span class="s2">&quot;iron maiden&quot;</span><span class="p">,</span>
  <span class="s2">&quot;the clash&quot;</span><span class="p">,</span>
  <span class="s2">&quot;ramones&quot;</span><span class="p">,</span>
  <span class="s2">&quot;madness&quot;</span><span class="p">,</span>
  <span class="s2">&quot;the rolling stones&quot;</span>
<span class="o">]</span>

<span class="k">def</span> <span class="nf">spell_check</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">treshold</span> <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="mi">83</span><span class="p">)</span>
  <span class="no">DICTIONARY</span><span class="o">.</span><span class="n">select</span> <span class="k">do</span> <span class="o">|</span><span class="n">word</span><span class="o">|</span>
    <span class="no">DidYouMean</span><span class="o">::</span><span class="no">JaroWinkler</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">treshold</span> 
  <span class="k">end</span><span class="o">.</span><span class="n">sort_by</span> <span class="k">do</span> <span class="o">|</span><span class="n">word</span><span class="o">|</span>
    <span class="no">DidYouMean</span><span class="o">::</span><span class="no">JaroWinkler</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span> 
  <span class="k">end</span><span class="o">.</span><span class="n">reverse</span>
<span class="k">end</span>

<span class="c1"># Since beginnings are similar,</span>
<span class="c1"># we get useful suggestions.</span>

<span class="n">spell_check</span><span class="p">(</span><span class="s2">&quot;the beles&quot;</span><span class="p">)</span>          <span class="c1"># [&quot;the beatles&quot;, &quot;the clash&quot;]</span>
<span class="n">spell_check</span><span class="p">(</span><span class="s2">&quot;sadness&quot;</span><span class="p">)</span>            <span class="c1"># [&quot;madness&quot;]</span>
<span class="n">spell_check</span><span class="p">(</span><span class="s2">&quot;the rolling santas&quot;</span><span class="p">)</span> <span class="c1"># [&quot;the rolling stones&quot;]</span>
<span class="n">spell_check</span><span class="p">(</span><span class="s2">&quot;ironman&quot;</span><span class="p">)</span>            <span class="c1"># [&quot;iron maiden&quot;]</span>
<span class="n">spell_check</span><span class="p">(</span><span class="s2">&quot;romans&quot;</span><span class="p">)</span>             <span class="c1"># [&quot;ramones&quot;]</span>

<span class="c1"># Since only endings are similar,</span>
<span class="c1"># we don&#39;t get useful suggestions.</span>

<span class="n">spell_check</span><span class="p">(</span><span class="s2">&quot;polite maiden&quot;</span><span class="p">)</span>      <span class="c1"># []</span>
<span class="n">spell_check</span><span class="p">(</span><span class="s2">&quot;car clash&quot;</span><span class="p">)</span>          <span class="c1"># []</span>
<span class="n">spell_check</span><span class="p">(</span><span class="s2">&quot;bowling stones&quot;</span><span class="p">)</span>     <span class="c1"># []</span>
<span class="n">spell_check</span><span class="p">(</span><span class="s2">&quot;los beatles&quot;</span><span class="p">)</span>        <span class="c1"># []</span>
</code></pre></div>
<h2>Levenshtein distance</h2>

<p>This metric gives us the number of edits needed to convert one word into another.</p>

<ul>
<li>0 means no edits are needed - words are identical</li>
</ul>

<p>Here are a couple of examples:</p>

<ul>
<li>Levenshtein distance between <code>foo</code> and <code>bar</code> is <code>3</code> since we had to change 3 characters</li>
<li>Levenshtein distance between <code>ruby</code> and <code>rugby</code> is <code>1</code> since we had to change 1 character</li>
</ul>

<p>I will not go into too much detail about how this algorithm works, but let&#39;s use
it on our previous example for spell checking band names:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="no">DICTIONARY</span> <span class="o">=</span> <span class="o">[</span>
  <span class="s2">&quot;the beatles&quot;</span><span class="p">,</span>
  <span class="s2">&quot;iron maiden&quot;</span><span class="p">,</span>
  <span class="s2">&quot;the clash&quot;</span><span class="p">,</span>
  <span class="s2">&quot;ramones&quot;</span><span class="p">,</span>
  <span class="s2">&quot;madness&quot;</span><span class="p">,</span>
  <span class="s2">&quot;the rolling stones&quot;</span>
<span class="o">]</span>

<span class="k">def</span> <span class="nf">spell_check</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">threshold</span> <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="mi">83</span><span class="p">)</span>
  <span class="n">threshold</span>  <span class="o">=</span> <span class="p">(</span><span class="n">term</span><span class="o">.</span><span class="n">length</span> <span class="o">*</span> <span class="mi">0</span><span class="o">.</span><span class="mi">25</span><span class="p">)</span><span class="o">.</span><span class="n">ceil</span>

  <span class="no">DICTIONARY</span><span class="o">.</span><span class="n">select</span> <span class="k">do</span> <span class="o">|</span><span class="n">word</span><span class="o">|</span>
    <span class="no">DidYouMean</span><span class="o">::</span><span class="no">Levenshtein</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">threshold</span> 
  <span class="k">end</span><span class="o">.</span><span class="n">sort_by</span> <span class="k">do</span> <span class="o">|</span><span class="n">word</span><span class="o">|</span>
    <span class="no">DidYouMean</span><span class="o">::</span><span class="no">Levenshtein</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># We no longer compare beginnings,</span>
<span class="c1"># so we get different results.</span>

<span class="n">spell_check</span><span class="p">(</span><span class="s2">&quot;the beles&quot;</span><span class="p">)</span>          <span class="c1"># [&quot;the beatles&quot;] &lt;- changed</span>
<span class="n">spell_check</span><span class="p">(</span><span class="s2">&quot;sadness&quot;</span><span class="p">)</span>            <span class="c1"># [&quot;madness&quot;]</span>
<span class="n">spell_check</span><span class="p">(</span><span class="s2">&quot;the rolling santas&quot;</span><span class="p">)</span> <span class="c1"># [&quot;the rolling stones&quot;]</span>
<span class="n">spell_check</span><span class="p">(</span><span class="s2">&quot;ironman&quot;</span><span class="p">)</span>            <span class="c1"># [] &lt;- changed</span>
<span class="n">spell_check</span><span class="p">(</span><span class="s2">&quot;romans&quot;</span><span class="p">)</span>             <span class="c1"># [] &lt;- changed</span>

<span class="c1"># Since only endings are similar,</span>
<span class="c1"># we don&#39;t get useful suggestions.</span>

<span class="n">spell_check</span><span class="p">(</span><span class="s2">&quot;polite maiden&quot;</span><span class="p">)</span>  <span class="c1"># []</span>
<span class="n">spell_check</span><span class="p">(</span><span class="s2">&quot;car clash&quot;</span><span class="p">)</span>      <span class="c1"># [&quot;the clash&quot;] &lt;- changed</span>
<span class="n">spell_check</span><span class="p">(</span><span class="s2">&quot;bowling stones&quot;</span><span class="p">)</span> <span class="c1"># []</span>
<span class="n">spell_check</span><span class="p">(</span><span class="s2">&quot;los beatles&quot;</span><span class="p">)</span>    <span class="c1"># [&quot;the beatles&quot;] &lt;- changed</span>
</code></pre></div>
<p>Notice the threshold set to 25%. This means that we are 
not going to consider two words similar if we have to change
more than 25% of the misspelled word to get to the valid word.</p>

<h2>Combining the algorithms</h2>

<p>Did You Mean uses a combination of these two algorithms in order
to improve its accuracy:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="no">DICTIONARY</span> <span class="o">=</span> <span class="o">[</span>
  <span class="s2">&quot;the beatles&quot;</span><span class="p">,</span>
  <span class="s2">&quot;iron maiden&quot;</span><span class="p">,</span>
  <span class="s2">&quot;the clash&quot;</span><span class="p">,</span>
  <span class="s2">&quot;ramones&quot;</span><span class="p">,</span>
  <span class="s2">&quot;madness&quot;</span><span class="p">,</span>
  <span class="s2">&quot;the rolling stones&quot;</span>
<span class="o">]</span>

<span class="k">def</span> <span class="nf">spell_check</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">threshold</span> <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="mi">83</span><span class="p">)</span>
  <span class="n">first_pass</span> <span class="o">=</span> <span class="no">DICTIONARY</span><span class="o">.</span><span class="n">select</span> <span class="k">do</span> <span class="o">|</span><span class="n">word</span><span class="o">|</span>
    <span class="no">DidYouMean</span><span class="o">::</span><span class="no">JaroWinkler</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">threshold</span> 
  <span class="k">end</span><span class="o">.</span><span class="n">sort_by</span> <span class="k">do</span> <span class="o">|</span><span class="n">word</span><span class="o">|</span>
    <span class="no">DidYouMean</span><span class="o">::</span><span class="no">JaroWinkler</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span> 
  <span class="k">end</span><span class="o">.</span><span class="n">reverse</span>

  <span class="n">threshold</span>  <span class="o">=</span> <span class="p">(</span><span class="n">term</span><span class="o">.</span><span class="n">length</span> <span class="o">*</span> <span class="mi">0</span><span class="o">.</span><span class="mi">25</span><span class="p">)</span><span class="o">.</span><span class="n">ceil</span>
  <span class="n">corrections</span> <span class="o">=</span> <span class="n">first_pass</span><span class="o">.</span><span class="n">select</span> <span class="k">do</span> <span class="o">|</span><span class="n">word</span><span class="o">|</span>
    <span class="no">DidYouMean</span><span class="o">::</span><span class="no">Levenshtein</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">threshold</span> 
  <span class="k">end</span><span class="o">.</span><span class="n">sort_by</span> <span class="k">do</span> <span class="o">|</span><span class="n">word</span><span class="o">|</span>
    <span class="no">DidYouMean</span><span class="o">::</span><span class="no">Levenshtein</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># Since beginnings are similar,</span>
<span class="c1"># we get useful suggestions.</span>

<span class="n">spell_check</span><span class="p">(</span><span class="s2">&quot;the beles&quot;</span><span class="p">)</span>          <span class="c1"># [&quot;the beatles&quot;]</span>
<span class="n">spell_check</span><span class="p">(</span><span class="s2">&quot;sadness&quot;</span><span class="p">)</span>            <span class="c1"># [&quot;madness&quot;]</span>
<span class="n">spell_check</span><span class="p">(</span><span class="s2">&quot;the rolling santas&quot;</span><span class="p">)</span> <span class="c1"># [&quot;the rolling stones&quot;]</span>
<span class="n">spell_check</span><span class="p">(</span><span class="s2">&quot;ironman&quot;</span><span class="p">)</span>            <span class="c1"># []</span>
<span class="n">spell_check</span><span class="p">(</span><span class="s2">&quot;romans&quot;</span><span class="p">)</span>             <span class="c1"># []</span>

<span class="c1"># Since only endings are similar,</span>
<span class="c1"># we don&#39;t get useful suggestions.</span>

<span class="n">spell_check</span><span class="p">(</span><span class="s2">&quot;polite maiden&quot;</span><span class="p">)</span>  <span class="c1"># []</span>
<span class="n">spell_check</span><span class="p">(</span><span class="s2">&quot;car clash&quot;</span><span class="p">)</span>      <span class="c1"># [] &lt;- changed</span>
<span class="n">spell_check</span><span class="p">(</span><span class="s2">&quot;bowling stones&quot;</span><span class="p">)</span> <span class="c1"># []</span>
<span class="n">spell_check</span><span class="p">(</span><span class="s2">&quot;los beatles&quot;</span><span class="p">)</span>    <span class="c1"># [] &lt;- changed</span>
</code></pre></div>
<h2>Back to formatter</h2>

<p>Now that we know how corrections get generated, we can go back to the original line inside <code>Correctable</code>:</p>

<figure class="highlight"><div class='source-location'>
          <a href='https://github.com/ruby/did_you_mean/blob/8175f6eefb9c55a8906fc8bce2dd3b7c03de3e59/lib/did_you_mean/core_ext/name_error.rb#L9'>
            lib/did_you_mean/core_ext/name_error.rb#L9 &nearr;
          </a>
        </div><pre><code class="language-ruby" data-lang="ruby"><div class="emphasized"><pre><span></span><span class="k">module</span> <span class="nn">DidYouMean</span>
  <span class="k">module</span> <span class="nn">Correctable</span>
    <span class="k">def</span> <span class="nf">original_message</span>
      <span class="nb">method</span><span class="p">(</span><span class="ss">:to_s</span><span class="p">)</span><span class="o">.</span><span class="n">super_method</span><span class="o">.</span><span class="n">call</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">to_s</span>
      <span class="n">msg</span> <span class="o">=</span> <span class="k">super</span><span class="o">.</span><span class="n">dup</span>
<span class="hll">      <span class="n">suggestion</span> <span class="o">=</span> <span class="no">DidYouMean</span><span class="o">.</span><span class="n">formatter</span><span class="o">.</span><span class="n">message_for</span><span class="p">(</span><span class="n">corrections</span><span class="p">)</span>
</span>
      <span class="n">msg</span> <span class="o">&lt;&lt;</span> <span class="n">suggestion</span> <span class="k">if</span> <span class="o">!</span><span class="n">msg</span><span class="o">.</span><span class="n">end_with?</span><span class="p">(</span><span class="n">suggestion</span><span class="p">)</span>
      <span class="n">msg</span>
    <span class="k">rescue</span>
      <span class="k">super</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">corrections</span>
      <span class="vi">@corrections</span> <span class="o">||=</span> <span class="n">spell_checker</span><span class="o">.</span><span class="n">corrections</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">spell_checker</span>
      <span class="no">SPELL_CHECKERS</span><span class="o">[</span><span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">to_s</span><span class="o">].</span><span class="n">new</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>The formatter is set to <code>PlainFormatter</code> here:</p>

<figure class="highlight"><div class='source-location'>
          <a href='https://github.com/ruby/did_you_mean/blob/8175f6eefb9c55a8906fc8bce2dd3b7c03de3e59/lib/did_you_mean.rb#L85-L110'>
            lib/did_you_mean.rb#L85-L110 &nearr;
          </a>
        </div><pre><code class="language-ruby" data-lang="ruby"><div class="emphasized"><pre><span></span><span class="k">module</span> <span class="nn">DidYouMean</span>
  <span class="c1"># Map of error types and spell checker objects.</span>
  <span class="no">SPELL_CHECKERS</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">NullChecker</span><span class="p">)</span>

  <span class="c1"># Adds +DidYouMean+ functionality to an error using a given spell checker</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">correct_error</span><span class="p">(</span><span class="n">error_class</span><span class="p">,</span> <span class="n">spell_checker</span><span class="p">)</span>
    <span class="no">SPELL_CHECKERS</span><span class="o">[</span><span class="n">error_class</span><span class="o">.</span><span class="n">name</span><span class="o">]</span> <span class="o">=</span> <span class="n">spell_checker</span>
    <span class="n">error_class</span><span class="o">.</span><span class="n">prepend</span><span class="p">(</span><span class="no">Correctable</span><span class="p">)</span> <span class="k">unless</span> <span class="n">error_class</span> <span class="o">&lt;</span> <span class="no">Correctable</span>
  <span class="k">end</span>

  <span class="n">correct_error</span> <span class="no">NameError</span><span class="p">,</span> <span class="no">NameErrorCheckers</span>
  <span class="n">correct_error</span> <span class="no">KeyError</span><span class="p">,</span> <span class="no">KeyErrorChecker</span>
  <span class="n">correct_error</span> <span class="no">NoMethodError</span><span class="p">,</span> <span class="no">MethodNameChecker</span>

  <span class="c1"># Returns the currenctly set formatter. By default, it is set to +DidYouMean::Formatter+.</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">formatter</span>
    <span class="vc">@@formatter</span>
  <span class="k">end</span>

<span class="hll">  <span class="c1"># Updates the primary formatter used to format the suggestions.</span>
</span><span class="hll">  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">formatter</span><span class="o">=</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
</span><span class="hll">    <span class="vc">@@formatter</span> <span class="o">=</span> <span class="n">formatter</span>
</span><span class="hll">  <span class="k">end</span>
</span><span class="hll">
</span><span class="hll">  <span class="nb">self</span><span class="o">.</span><span class="n">formatter</span> <span class="o">=</span> <span class="no">PlainFormatter</span><span class="o">.</span><span class="n">new</span>
</span><span class="k">end</span></code></pre></figure>

<p><code>PlainFormatter</code> simply appends the suggestion message to the end of exception message:</p>

<figure class="highlight"><div class='source-location'>
          <a href='https://github.com/yuki24/did_you_mean/blob/8175f6eefb9c55a8906fc8bce2dd3b7c03de3e59/lib/did_you_mean/formatters/plain_formatter.rb'>
            lib/did_you_mean/formatters/plain_formatter.rb &nearr;
          </a>
        </div><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="c1"># frozen-string-literal: true</span>

<span class="k">module</span> <span class="nn">DidYouMean</span>
  <span class="c1"># The +DidYouMean::PlainFormatter+ is the basic, default formatter for the</span>
  <span class="c1"># gem. The formatter responds to the +message_for+ method and it returns a</span>
  <span class="c1"># human readable string.</span>
  <span class="k">class</span> <span class="nc">PlainFormatter</span>

    <span class="c1"># Returns a human readable string that contains +corrections+. This</span>
    <span class="c1"># formatter is designed to be less verbose to not take too much screen</span>
    <span class="c1"># space while being helpful enough to the user.</span>
    <span class="c1">#</span>
    <span class="c1"># @example</span>
    <span class="c1">#</span>
    <span class="c1">#   formatter = DidYouMean::PlainFormatter.new</span>
    <span class="c1">#</span>
    <span class="c1">#   # displays suggestions in two lines with the leading empty line</span>
    <span class="c1">#   puts formatter.message_for([&quot;methods&quot;, &quot;method&quot;])</span>
    <span class="c1">#</span>
    <span class="c1">#   Did you mean?  methods</span>
    <span class="c1">#                   method</span>
    <span class="c1">#   # =&gt; nil</span>
    <span class="c1">#</span>
    <span class="c1">#   # displays an empty line</span>
    <span class="c1">#   puts formatter.message_for([])</span>
    <span class="c1">#</span>
    <span class="c1">#   # =&gt; nil</span>
    <span class="c1">#</span>
    <span class="k">def</span> <span class="nf">message_for</span><span class="p">(</span><span class="n">corrections</span><span class="p">)</span>
      <span class="n">corrections</span><span class="o">.</span><span class="n">empty?</span> <span class="p">?</span> <span class="s2">&quot;&quot;</span> <span class="p">:</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Did you mean?  </span><span class="si">#{</span><span class="n">corrections</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">               &quot;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>And that&#39;s it, we now know how Did You Mean appends its corrections
to the error messages.</p>

<h2>Bonus</h2>

<p>As a reward for completing this article, I&#39;d like to introduce a gem
that autofixes the suggestions from DidYouMean. It&#39;s called <a href="https://github.com/shime/i_did_mean">I Did Mean</a>
and it comes with Rails integration.</p>

<p>Try it out and let me know what you think!</p>


          <hr />

          <div class="mt-12 mb-16">
            <div class="relative flex justify-between items-start w-full z-20 self-center">
  <div class="flex items-start">
    <a class="self-start w-16 h-16" href="https://shime.sh">
      <img class="self-start rounded-full w-16 h-16" src='/public/shime.jpg' alt='' />
    </a>

    <div class="flex flex-col ml-4">
      <a class=" font-bold text-xl no-underline font-extrabold self-start" href="https://twitter.com/shime_sh">Hrvoje Šimić</a>
      <a class=" font-bold no-underline font-extrabold my-1 self-start" href="https://twitter.com/shime_sh">@shime_sh</a>
      <ul class="hidden md:block list-reset tracking-wide">
      </ul>
    </div>
  </div>
</div>

          </div>

          <p class="mt-4">
            Did you like this article? You can <a href="https://twitter.com/shime_sh">follow me on Twitter</a>, subscribe to the newsletter or <a  href="/feed.xml">subscribe to the RSS feed</a> if you'd like to follow along.

            <div class="mt-2">
              <form
  action="https://buttondown.email/api/emails/embed-subscribe/twobucks"
  method="post"
  target="popupwindow"
  onsubmit="window.open('https://buttondown.email/twobucks', 'popupwindow')"
  class="embeddable-buttondown-form"
>
  <div class="flex max-w-sm m-auto">
    <input type="email" name="email" id="bd-email" class="bg-grey-lighter appearance-none rounded rounded-r-none w-full py-2 px-4 text-grey-darker leading-tight focus:outline-none"  placeholder="Enter your best email address">
    <input type="hidden" value="1" name="embed"></input>
    
    <input type="hidden" name="tag" value="articles" />
    
    <input type="submit" value="Subscribe" class="cursor-pointer shadow bg-black hover:bg-grey-darkest focus:outline-none text-white font-bold py-2 px-4 rounded rounded-l-none"></input>
  </div>
  <div class="flex text-xs max-w-sm m-auto"><span>Unsubscribe anytime. By submitting email, you agree to Buttondown's <a href="https://buttondown.email/privacy">privacy policy</a>.</span></div>
</form>

            </div>
          </p>
        </div>
      </div>
    </div>
  </body>

  <script>
  var menu = document.querySelectorAll('[data-hamburger-menu]')[0]
  var openMenu = document.querySelectorAll('[data-open-hamburger-menu]')[0]
  var closeMenu = document.querySelectorAll('[data-close-hamburger-menu]')[0]
  var body = document.body

  openMenu.onclick = toggleMenu.bind(this, true);
  closeMenu.onclick = toggleMenu.bind(this, false);

  function toggleMenu(show) {
    toggleElements([openMenu], !show);
    toggleElements([menu, closeMenu], show);
    toggleScrolling(body, show);
  }

  function toggleElements(elements, show) {
    elements.forEach(function(element) {
      if (show) {
        element.classList.remove("hidden")
        element.classList.add("block");
      } else {
        element.classList.remove("block")
        element.classList.add("hidden");
      }
    })
  }

  function toggleScrolling(element, scrollDisabled) {
    var classes = ["scrolling-auto", "overflow-hidden", "fixed", "pin-x"];
    if (scrollDisabled) {
      classes.forEach(function(klass){
        element.classList.add(klass);
      })
    } else {
      classes.forEach(function(klass){
        element.classList.remove(klass);
      })
    }
  }

  var anchors = new AnchorJS();
  anchors.options = {
    placement: 'left'
  }
  anchors.add()
</script>

</html>
